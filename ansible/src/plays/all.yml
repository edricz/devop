---

# # Ubuntu 16.04 does not install python2 by default
# - name: Install Python2
#   hosts: tag_env_ops
#   remote_user: ubuntu
#   become: True
#   gather_facts: False
#   tasks:
#     - raw: apt-get update && apt-get install -y python

- name: Launch AWS instances
  hosts: localhost
  connection: local
  gather_facts: False
  roles:
    - aws

- name: Bootstrap ops instances
  hosts: tag_env_ops
  remote_user: ubuntu
  become: True
  pre_tasks:
    - name: Check bootstrapped file
      stat: path=/.bootstrapped
      ignore_errors: true
      register: bootstrapped
    - apt: update_cache=yes cache_valid_time=21600
      when: bootstrapped.stat.exists == false
  roles:
    - { role: base, when: "bootstrapped.stat.exists == false" }
    - { role: fstab, when: "bootstrapped.stat.exists == false" }
    - { role: docker, when: "bootstrapped.stat.exists == false" }
    - { role: snmpd, when: "bootstrapped.stat.exists == false" }
    - { role: dnsmasq, when: "bootstrapped.stat.exists == false" }
  post_tasks:
    - name: Create bootstrapped file
      copy:
        content: "{{ ansible_date_time.iso8601_micro }}"
        dest: /.bootstrapped
      when: bootstrapped.stat.exists == false

- name: Launch Docker registry service
  hosts: tag_env_ops
  become: True
  roles:
    - { role: registry, tags: ['registry'] }
  serial: 1

- name: Launch etcd cluster membership service
  hosts: tag_env_ops
  become: True
  roles:
    - { role: etcd,
        etcd_discovery_url: "https://discovery.etcd.io/3f680108254449b35af358500d9ebe48",
        tags: ['etcd'],
        when: "ec2_region == 'us-west-2'" }
    - { role: etcd,
        etcd_discovery_url: "https://discovery.etcd.io/0891cf9e69e74f6ccaa4e2cc1a24a895",
        tags: ['etcd'],
        when: "ec2_region == 'us-west-1'" }

- name: Launch haproxy load balancer
  hosts: tag_env_ops
  become: True
  roles:
    - { role: etcd-register, tags: ['etcd'] }
    - { role: confd-haproxy, tags: ['loadbalancer'] }

- name: Configure DNS load balancing service
  hosts: tag_env_ops
  roles:
    - { role: loadbalancer, tags: ['loadbalancer'] }
  serial: 1

- name: Create latency based DNS entries
  hosts: localhost
  connection: local
  gather_facts: False
  tasks:
    - { include: ../roles/loadbalancer/tasks/update_route53.yml, tags: ['loadbalancer'] }

- hosts: tag_jenkins_master
  become: True
  roles:
    - { role: jenkins, tags: ['jenkins'] }
